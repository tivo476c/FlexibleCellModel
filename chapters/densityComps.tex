\section{Density computations} \label{density}

In the previous chapter, we employed Monte Carlo simulations to validate the microscopic cell model and to illustrate the qualitative behaviour emerging from the underlying gradient-flow dynamics. 
While such simulations provide valuable empirical insight, they do not yet reveal the macroscopic, continuum-level structure of the system. \\
In this chapter, we therefore develop a systematic framework to pass from individual cell dynamics to a description in terms of probability measures and densities. 
We introduce the empirical measure associated with large ensembles of simulated cells, explain its convergence to the first marginal of the $N_C$-cell system, and analyse the subsequent mean-field limit as $N_C \rightarrow \infty$. \\
%TODO: in the end really write down what we have done: 
This leads naturally to a deterministic transport equation for the limiting cell density, which provides a mathematically transparent interpretation of the collective dynamics. 
We illustrate this approach with an explicit low dimensional needle cell example. 
Afterwards, we compute the mean field PDEs for our DF model with sorely the area, edge or interior angle force applied, respectively. 
Unfortunately, we did not manage to do the same for our interaction term in this thesis, as there was not enough time. 
%now introduce empirical measure: 
- for our point particle monte carlo simulations, we can define the empirical measure 
\begin{align*}
    &\mu^{(N_C, N_S)}_t: \mathcal{B}(\R^2) \: \longrightarrow \: [0,1],  \\
    A \: \longmapsto \: &\mu^{(N_C, N_S)}_t(A) = \frac{1}{N_C N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{s=1}^{N_S} \delta_{\vec{x}_i^{\:(s)}(t)}(A),
\end{align*}
where $N_C$ is again the number of cells in each simulation, $N_S$ denotes the number of simulations in the Monte Carlo simulation and $\vec{x}_i^{\:(s)}(t) \in \Omega \subset \R^2$ is the location of point particle $1 \leq i \leq N_C$ in simulation $1 \leq s \leq N_S$ and at time $t \in [0, T]$.   \\
$\mathcal{B}(\R^2)$ is the Borel sigma-algebra on $\R^2$ and \( \delta_{\vec{x}_i(t)} \) denotes the Dirac measure: 
\begin{align*}
    &\delta_{\vec{x}_i(t)}: \mathcal{B}(\R^2) \: \longrightarrow \: \{0,1\},  \\
    A \: \longmapsto \: &\delta_{\vec{x}_i(t)}(A) = \begin{cases}
        1 & \text{if } \vec{x}_i(t) \in A, \\
        0 & \text{if } \vec{x}_i(t) \notin A.
   \end{cases}
\end{align*}
For any test function \( \phi \in C_c^\infty(\R^2) \), the Dirac measure satisfies
\[
\int_{\R^2} \phi(x) \dequ \delta_{\vec{x}_i(t)}(x) = \phi(\vec{x}_i(t)).
\]

- For a set $A \in \mathcal{B}(\R^2)$, $\mu^{(N_C, N_S)}_t(A)$ is the relative proportion of the $N_C$ particles that are located in $A$ at time $t$, throughout all $N_S$ simulations. \\
- Our heatmaps from Chapter~\ref{sanitycheck} use sets $\{A_{lc}\}_{l,c=1}^{N_H}$ for the visualisation of that empirical measure, where ${N_H}^2$ is the number of sub squares we divide $\Omega$ into.  \\
- Any sub square $A_{lc}$ of the original domain $\Omega = [-0.5, 0.5]^2$ has side length $\dfrac{1}{N_H}$. \\
- As we increase $N_H$, we get a finer approximation of $\Omega$. \\ 

- The law of large numbers yields that the empirical measure $\mu^{(N_C, N_S)}_t$ converges to the first marginal distribution $\rho(t; \vec{x})$, if the following requirements are met:
\begin{itemize}
    \item the first marginal $\rho(t; \vec{x})$ exists, 
    \item the simulations are independent and identically distributed (iid),
    \item the expected value $\int_{\Omega} \phi(\vec{x}) \rho(t; \vec{x}) \dequ x < \infty $.
\end{itemize}
% TODO: check these
The particle dynamics are well-posed, so the distribution of particle positions at time $t$ exists and is a probability measure. 
Therefore, its projection onto the first endpoint—the first marginal—also exists. \\
Each simulation run uses an independent random seed and samples the initial particle configuration independently from the same distribution $\mathcal{N}_2((0.5,0.5), 0.09^2 I_2)$. 
The subsequent dynamics are deterministic given the initial state, so the entire trajectories remain independent across simulations. 
Since all simulations start from the same distribution and evolve under the same deterministic flow, they are identically distributed. 
Thus, the collection of simulation outcomes $\{X^{(s)}_t\}_{s=1}^{N_S}$ forms an iid family for every fixed time $t$. \\
The initial distribution is Gaussian on a bounded domain and therefore admits finite moments of all orders. 
Moreover, the particle dynamics are smooth and preserve finiteness of expectations as no singularities or blow-up mechanisms are present. 
Hence, for any test function $\phi \in C_c^\infty(\Omega)$ we have 
\[
    \int_\Omega \phi(\vec{x}) \rho(t;\vec{x}) \, \mathrm{d}x < \infty,
\]
ensuring that expectations of observables remain finite for all times. \\

We call the limit $N_S \rightarrow \infty$ Monte Carlo limit. \\ 

- But there is also a further limit to consider: the mean field limit. 
- Here, we let the number of cells $N_C \rightarrow \infty$. 
- In the mean field limit, we can study the transition from the microscopic model view, that uses a finite number of cells, $N_C < \infty$, to a macroscopic model view where we consider the whole system's density without individual cells, as $N_C \rightarrow \infty$.
- As $N_C \rightarrow \infty$, our first marginal $\rho$ converges to the mean field density $\bar{\rho}$
\begin{center}
    $
    \rho \xrightarrow {N_C \to \infty } \bar{\rho}.
    $
\end{center}
% TODO: explain condition further and why it works for us 
- The condition for this is that the cell interaction is `symmetrical' and `weak', e.g. 
\begin{align*}
    \frac{\dequ \vec{x}_i(t)}{\dequ t} = \dfrac{1}{N_C} \sum_{j=1}^{N_C} f(\vec{x}_i(t), \vec{x}_j(t)),
\end{align*}
such that the influence of each other cell is in $\mathcal{O}(\tfrac{1}{N_C})$. \\

% TODO: explain that figure illustrating the mean field limit transition 
% For a finite $N_C \in \N$, $\mu^{N_C}$ is a discrete measure that only has its mass divided on the exact particle locations. 
% As we increase the number of particles, $\mu^{N_C}$ will spread out \,-\, having more particle locations to cover with each particle having a lower influence on the result of $\mu^{N_C}$ as we divide through $N_C$.
% This process is quite simular to the transition from a sum to an according integral:
% \[ \sum\limits_{i=1}^{N_C} \frac{1}{N_C} f(x_i) \xrightarrow{N \to \infty} \int f(x) \dequ x,  \]
% where we can also see a transition from a discrete starting problem, having discrete points ${x_i}$, to a continious integral where $x \in (a,b)$. 
% As $\mu^N$ is a measure that lives on sets $A \in \mathcal{B}(\R^d)$, we cannot directly plot it as a function. 
% Instead, we try to visualise it meaningfully by using histograms as approximations in Figure~\ref{fig:muTransition}.
% This is also a good connection from the previus section, where we also used histograms to show the results of the monte carlo simulations. 

% \begin{figure}
% 	\begin{center}
% 		\includegraphics[width=15cm]{density/muplot_combined.png}
% 		\caption{
%             Visualisation of empirical measures $\mu^{N_C}$ for increasing numbers of cells, alongside the corresponding theoretical density. 
%             This visualisation illustrates the transition \( \mu^{N_C} \xrightarrow{N_C \to \infty} \mu\). \\
%             All cell configurations are sampled from the same initial condition described in the previous chapter: a two-dimensional normal distribution \( \mathcal{N}_2((0,0), \sigma^2 I_2) \) with \( \sigma = 0.09 \). 
%             In the first three subplots, the domain \([-0.5, 0.5]^2\) is discretised into square bins of side length \(\frac{1}{50}\). 
%             Each bin \( A \) corresponds to a measurable set in the definition of the empirical measure \( \mu^{N_C}(A) = \frac{1}{N_C} \sum_{i=1}^{N_C} \delta_{x_i}(A) \), where the color intensity encodes the number of cells in that bin. \\
%             The first subplot shows a realisation with \( N_C = 20 \) cells, the second with \( N_C = 200 \), and the third with \( N_C = 20{.}000 \). 
%             We observe that as \( N_C \) increases, the empirical measure \( \mu^{N_C} \) becomes a smoother approximation of the underlying density. 
%             The color scale is fixed across all subplots to allow direct visual comparison.
%             The fourth panel displays the exact density function of the initial distribution, \( \rho(x) = \frac{1}{2\pi\sigma^2} \exp\left( -\frac{\|x\|^2}{2\sigma^2} \right) \), with \( \sigma = 0.09 \). 
%          }
% 		\label{fig:muTransition}
% 	\end{center}
% \end{figure}

% The distribution from the fourth subplot in Figure~\ref{fig:muTransition} is aimed to be computed for the dynamics of our DF cell model. 

% In the end, we want to achieve:
% \[ \mu^{N_C} \xrightarrow{N_C \to \infty} \mu\]
% by letting the number of cells go to infinity. \\


% now: computation of mean field density PDE 
- Next, we will show how the PDE for the mean field density temporal evolution can be computed generally, if the particle dynamic is given by the gradient flow of a given energy. 

% Lets define our cell centres with:
% \begin{gather*}
%     \vec{X}(t) = (\vec{x}_1(t), \ldots, \vec{x}_{N_C}(t)) \in \R^{2 N_C}. \\
% \end{gather*}

We use a cell wise energy  
\begin{align*}
    E: \R^{2} \: &\longrightarrow \:  \R, \\ 
    \vec{x} \: &\longmapsto \: E(\vec{x}).
\end{align*}

We define the dynamic of a particle $\vec{x}_i$ via: \\
\[ 
    \dfrac{\dequ \vec{x}_i}{\dequ t} = - \nabla E(\vec{x}_i) \in \R^{2}. 
\]

Let $\phi \in C_c^{\infty}(\R^{2}, \R)$ be a test function. 
Its gradient field is $ \nabla \phi : \R^2 \rightarrow \R^2$. 
We compute: 
\begin{align*}
    \frac{\dequ}{\dequ t} \int_{\Omega} \phi \: \dequ \mu^{(N_C, N_S)}_t
    &= \frac{\dequ}{\dequ t} \left[\frac{1}{N_C N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{s=1}^{N_C} \phi(\vec{x}_i^{\: (s)})\right] \\
    &= - \frac{1}{N_C N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{s=1}^{N_C} \nabla \phi(\vec{x}_i^{\: (s)}) \cdot \nabla E(\vec{x}_i^{\: (s)}) \\
    % &= - \frac{1}{N_C N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{s=1}^{N_C} \int_{\Omega} \nabla \phi(x) \cdot \nabla_{\vec{x}_i^{\: (s)}} E(\vec{X}) \: \dequ \delta_{\vec{x}_i^{\: (s)}} \\
    &= - \int_{\Omega} \nabla \phi(x) \cdot \nabla E(x) \: \dequ \mu^{(N_C, N_S)}_t \\
    &= \int_{\Omega} \phi(x)  \nabla \cdot ( \mu^{(N_C, N_S)}_t \nabla E(x)) \: \dequ x. \\
\end{align*}
% TODO: what is \mu^{(N_C, N_S)}_t \nabla E(x) from last line above 
This computation yields the continuity equation for our empirical measure $\mu^{(N_C, N_S)}_t$
\begin{align*}
    \frac{\partial \mu^{(N_C, N_S)}_t}{\partial t} + \nabla \cdot (\mu^{(N_C, N_S)}_t \, \nabla E) = 0.
\end{align*}
If we let $N_C \rightarrow \infty$ and assume convergence 
\begin{align*}
    \mu^{(N_C, N_S)}_t \xrightarrow {N_C, N_S \to \infty} \bar{\rho} \: \dequ x,
\end{align*} 
we obtain the PDE for the macroscopic density
\begin{align}
    \frac{\partial \bar{\rho}}{\partial t} + \nabla \cdot (\bar{\rho} \, \nabla E) = 0.
    \label{equ:meanfieldPDE}
\end{align}

If we want to apply this computation on our DF model, we must adapt our empirical measure. 
In the DF model, we model cells as polygons with $N_V \in \N$ vertices. 
Thus, we need to use these vertices for our measure, instead of the particle locations, e.g.
\begin{align*}
    &\mu^{(N_C, N_S)}_t: \mathcal{B}(\R^2) \: \longrightarrow \: [0,1],  \\
    A \: \longmapsto \: &\mu^{(N_C, N_S)}_t(A) = \frac{1}{N_C N_V N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{j=1}^{N_V} \sum\limits_{s=1}^{N_S} \delta_{\vec{v}_i^{\:(j, s)}(t)}(A),
\end{align*}
where $\vec{v}_i^{\:(j, s)}(t)$ is the $j$th vertex of cell $i$ at time $t$ in simulation $s$. \\ 
However, PDE~\eqref{equ:meanfieldPDE} for the mean field density remains the same.  



\subsection{1d needle cells}
% TODOs: formulate everything, figure captions, formatting
In order to demonstrate how the preceding computations can be applied in practice, we begin with a lower dimensional example. 
In this setting, each cell consists of two vertices situated in one spatial dimension, 
\begin{align*}
    C = \{v_1, v_2\}, \quad v_1, v_2 \in \R 
\end{align*}
where we assume $v_1 \neq v_2$ and that their ordering remains fixed throughout the simulation. 
This ensures that cells do not attain negative length. \\
Our dynamic naturally fulfils this condition, as we use the cell wise energy 
\begin{align*}
    E(C) = \tfrac{1}{2} \left| |v_1 - v_2| - E_d  \right|^2,
\end{align*}
where $E_d$ is the desired edge length of each cell. 
This energy lets each needle cell to recover a length of $E_d$. \\
Applying gradient flow dynamics yields
\begin{align*}
    \frac{\dequ v_1}{\dequ t} 
    &= - \nabla_{v_1} E(C) \\
    &= - \nabla_{v_1} \tfrac{1}{2}| |v_1 - v_2| - E_d |^2 \\
    &= - (|v_1 - v_2| - E_d) \nabla_{v_1} |v_1 - v_2|  \\
    &= - sgn(v_1 - v_2) (|v_1 - v_2| - E_d),   \\
\end{align*}
and 
\begin{align*}
    \frac{\dequ v_2}{\dequ t} 
    &=  sgn(v_1 - v_2) (|v_1 - v_2| - E_d).  \\
\end{align*}
The resulting cell dynamics take the compact form
\begin{align*}
    \frac{\dequ C}{\dequ t} = F(C) = \underbrace{sgn(v_1 - v_2) (|v_1 - v_2| - E_d)}_{\displaystyle = \alpha} \begin{pmatrix}
        -1 \\ 
        1
    \end{pmatrix}.
\end{align*}

For the subsequent derivation we require the computations 
\begin{align*}
    \nabla_{v_1} \cdot \alpha 
    &= \nabla_{v_1} \cdot (sgn(v_1 - v_2) (|v_1 - v_2| - E_d)) \\
    &= (\nabla_{v_1} \cdot sgn(v_1 - v_2)) (|v_1 - v_2| - E_d) 
      +  sgn(v_1 - v_2)(\nabla_{v_1} \cdot (|v_1 - v_2| - E_d) ) \\
    &= 0 + sgn(v_1 - v_2)(\nabla_{v_1} \cdot (|v_1 - v_2|) ) \\
    &= sgn(v_1 - v_2) sgn(v_1 - v_2) \\
    &= 1,
\end{align*}
and 
\begin{align*}
    \nabla_{v_2} \cdot \alpha 
    &= \nabla_{v_2} \cdot (sgn(v_1 - v_2) (|v_1 - v_2| - E_d)) \\
    &= (\nabla_{v_2} \cdot sgn(v_1 - v_2)) (|v_1 - v_2| - E_d) 
      +  sgn(v_1 - v_2)(\nabla_{v_2} \cdot (|v_1 - v_2| - E_d) ) \\
    &= 0 + sgn(v_1 - v_2)(\nabla_{v_2} \cdot (|v_1 - v_2|) ) \\
    &= sgn(v_1 - v_2) (- sgn(v_1 - v_2)) \\
    &= -1,
\end{align*}

With these identities at hand, we compute the divergence
\begin{align*}
    \nabla_C \cdot (\bar{\rho} F) 
    &= \nabla_{v_1} \cdot (\bar{\rho} F_1)  + \nabla_{v_2} \cdot (\bar{\rho} F_2) \\
    &= (\nabla_{v_1} \cdot \bar{\rho}) F_1 + \bar{\rho} (\nabla_{v_1} \cdot F_1) + (\nabla_{v_2} \cdot \bar{\rho}) F_2 + \bar{\rho} (\nabla_{v_2} \cdot F_2) \\
    &= - (\nabla_{v_1} \cdot \bar{\rho}) \alpha - \bar{\rho} (\nabla_{v_1} \cdot \alpha) + (\nabla_{v_2} \cdot \bar{\rho}) \alpha + \bar{\rho} (\nabla_{v_2} \cdot \alpha) \\
    &= - (\nabla_{v_1} \cdot \bar{\rho}) \alpha - \bar{\rho} + (\nabla_{v_2} \cdot \bar{\rho}) \alpha - \bar{\rho} \\
    &= - 2 \bar{\rho} + \alpha(- \nabla_{v_1} \cdot \bar{\rho} + \nabla_{v_2} \cdot \bar{\rho})   \\
\end{align*}
where $F = (F_1, F_2)^T$.  \\
Consequently, in the mean field limit $N_C \rightarrow \infty$, the density $\bar{\rho}$ satisfies
\begin{align*}
    \frac{\partial \bar{\rho}}{\partial t} + 2 \bar{\rho} - \alpha(- \nabla_{v_1} \cdot \bar{\rho} + \nabla_{v_2} \cdot \bar{\rho}) = 0,
\end{align*}
according to Equation~\eqref{equ:meanfieldPDE}. \\
To illustrate this model, we present two corresponding simulations.  
First, we consider a finite system of $N_C = 400$ needle cells.  
Each cell is initialised according to
\begin{center}
    $
    C_i = (v^{i}_1, v^{i}_2) \sim \mathcal{N}_2((0.5,0.5)^T, 0.09^2 \cdot I_2), \quad 1 \leq i \leq 400.
    $
\end{center}
We then evolve the system under the dynamics
\begin{align*}
    \frac{d C}{dt} = F(C) = sgn(v_1 - v_2) (|v_1 - v_2| - E_d)(-1, 1)^T,
\end{align*}
using a desired edge length of $E_d = 0.2$.  
The resulting ODE system is integrated with an explicit Euler method using a time step of $\Delta t = 10^{-3}$ over the interval $[0,1]$, giving $100$ time steps. \\
Figure~\ref{fig:needle400} visualises the evolution of the one dimensional needle cell system. 
Each cell is represented by a blue point in the $(v_1,v_2)$ plane, where the horizontal axis corresponds to the position of the first vertex and the vertical axis to that of the second vertex. 
Such a representation is only possible in this lower-dimensional setting, since the full vertex configuration of a cell can be embedded in $\R^2$. \\
At initial time, the $N_C = 400$ cells are sampled from the distribution $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$. 
As time progresses, the dynamics drive each cell towards its desired edge length $E_d = 0.2$. 
In the scatter plot, this manifests as a gradual migration of points towards the two diagonal lines defined by $|v_1 - v_2| = 0.2$, corresponding to cells whose vertex separation has achieved the prescribed value. 
By the final time, all cells lie precisely on these two diagonals, confirming that the system converges to a configuration in which every cell has relaxed to the target length. \\

\begin{figure}[h!]
    \centering
    
    \begin{tabular}{ccc}
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t1.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t2.png} &  
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t3.png} \\   

        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t4.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t5.png} &  
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t6.png} \\    
    \end{tabular}

    \caption{Scatter plots showing the evolution of $N_C = 400$ one dimensional needle cells at times $t \in \{0.0, 0.2, \ldots, 1.0\}$. 
    Each blue point represents a single cell, with the horizontal axis indicating the location of the first vertex $v_1$ and the vertical axis the location of the second vertex $v_2$. 
    The initial conditions are drawn from $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$. The dynamics aim to achieve a desired edge length of $E_d = 0.2$, corresponding to the two diagonal lines defined by $|v_1 - v_2| = 0.2$.}

	\label{fig:needle400}    
\end{figure}



Subsequently, we examine the associated mean field dynamics.  
We choose an initial condition given by $\mathcal{N}_2((0.5,0.5)^T, 0.09^2 \cdot I_2)$ on the domain $\Omega = [0.0, 1.0]^2$ and evolve it using the PDE
\begin{align*}
    \frac{\partial \bar{\rho}}{\partial t}  = \nabla_{v_1} \cdot (- \bar{\rho} \alpha)  + \nabla_{v_2} \cdot (\bar{\rho} \alpha),
\end{align*}
which arises from the earlier derivation of the density evolution equation.  
The discretisation is given by
% TODO: fix this
\begin{align*}
    \Omega \: &\longrightarrow \: \{A_{ij}\}_{i,j = 1}^{500} \text{ sub squares}, \\[0.5em]
    \bar{\rho} \: &\longrightarrow \: \bar{\rho}_{ij}^{\: k} \text{ density value on } A_{ij} \text{ at time step } k \in \N, \\[0.5em]
    \partial_t \bar{\rho} \: &\longrightarrow \: \frac{\bar{\rho}_{ij}^{\: k+1} - \bar{\rho}_{ij}^{\: k}}{\Delta t}, \\[0.5em] 
    \alpha \: &\longrightarrow \: \alpha_{ij}^k \text{ value on } A_{ij} \text{ at time step } k \in \N, \\[0.5em]
    \nabla_{v_1} \cdot (- \bar{\rho} \alpha) \: &\longrightarrow \: \frac{- \bar{\rho}_{i,j+1}^{\: k} \alpha_{i,j+1}^k + \bar{\rho}_{i,j-1}^{\: k} \alpha_{i,j-1}^k}{2 \Delta x},  \\[0.5em]
    \nabla_{v_2} \cdot (\bar{\rho} \alpha) \: &\longrightarrow \: \frac{ \bar{\rho}_{i+1,j}^{\: k} \alpha_{i+1,j}^k - \bar{\rho}_{i-1,j}^{\: k} \alpha_{i-1,j}^k}{2 \Delta x}, 
\end{align*}
with grid spacing $\Delta x = \tfrac{1}{500}$.  

Figure~\ref{fig:needle-limit} illustrates the evolution of the cell density in the mean field limit. 
The initial distribution is given by $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$ on the domain $[0,1]^2$, forming a concentrated region in the centre of the domain. 
Under the action of the mean field PDE, the density is gradually transported towards the two diagonal lines characterised by $|v_1 - v_2| = 0.2$, mirroring the behaviour observed in the finite-particle simulation from Figure~\ref{fig:needle400}. 
As time evolves, the solution develops sharp ridges along these diagonals, and by the final time almost all mass is concentrated on there, indicating convergence towards the desired edge length in the continuum description.

During the evolution, small oscillations appear in the region between the two diagonals. 
These artefacts are purely numerical and originate from the central difference discretisation used for the spatial derivatives. They can be removed by employing an upwind scheme, which would provide the correct directional bias in the discretisation of the fluxes and thereby suppress non-physical oscillations. 


\begin{figure}[h!]
    \centering
    
    \begin{tabular}{ccc}
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t1-equal-scale.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t2-equal-scale.png} &   
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t3-equal-scale.png} \\   

        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t4-equal-scale.png} & 
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t5-equal-scale.png} &   
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t6-equal-scale.png} \\  
    \end{tabular}

    \caption{Evolution of the mean field density starting from the initial distribution $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$ on the domain $[0,1]^2$. 
    The PDE dynamics transport the density towards the two diagonal lines defined by $|v_1 - v_2| = 0.2$, along which the mass becomes concentrated over time. 
    The plots display the density at successive time instances and include small oscillations between the diagonals arising from the central-difference discretisation; these could be removed through an upwind treatment of the spatial gradients.}
	\label{fig:needle-limit}    
\end{figure}

\subsection{DF edge energy mean field density} 
- After the lower dimensional example, we now want to continue with our DF model. 
- Let us consider DF cells as lists of two dimensional vertices, e.g.
\begin{align*}
    C = (\vec{v}_1, \ldots, \vec{v}_{N_V}).
\end{align*}
We restrict our energy to the edge energy from Equation~\ref{eq:edgeEnergy}, i.e.
\begin{align*}
    E_2(C) =  \sum\limits_{j=1}^{N_V} \tfrac{1}{2} |E^j_{C} - E^{j}_d|^2,
\end{align*}
with actual edge length $E^j_{C} = \norm[\vec{v}_j - \vec{v}_{j+1}]$ and desired length $E^{j}_d$ at edge $j$.
In order to compute the mean field density of this system, we need to compute 
\begin{align*}
    \nabla_C \cdot (\bar{\rho} \, \nabla_C E_2(C))
    &= \sum\limits_{j=1}^{N_V} \nabla_{\vec{v}_j} \cdot (\bar{\rho} \, \nabla_{\vec{v}_j} E_2(C)) \\
    &= \sum\limits_{j=1}^{N_V} (\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} E_2(C) + \bar{\rho} \, (\nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} E_2(C)).
\end{align*}
We already computed the energy gradient in Equation~\eqref{gradient:edge}.
It is given by 
\begin{align*}
    \nabla_{\vec{v}_j} E_2(C) &=  \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j-1}^{x} \\[0.5em]  v_{j}^{y} - v_{j-1}^{y}  \end{pmatrix} 
    + \dfrac{E^j_{C} - E_d^{j}}{E^j_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j+1}^{x} \\[0.5em]  v_{j}^{y} - v_{j+1}^{y} \end{pmatrix}.
\end{align*}
For the following computation, we use the derivatives
\begin{align*}
    \frac{\dequ}{ \dequ v_j^x} E^{j-1}_{C} 
    &= \frac{\dequ}{ \dequ v_j^x} \norm[\vec{v}_{j-1} - \vec{v}_{j}] \\
    &= \frac{\dequ}{ \dequ v_j^x} \left[ \left( (v_{j-1}^x - v_{j}^x)^2 + (v_{j-1}^y - v_{j}^y)^2 \right)^{\tfrac{1}{2}} \right] \\
    &= \frac{1}{2 \norm[\vec{v}_{j-1} - \vec{v}_{j}]} \frac{\dequ}{ \dequ v_j^x} \left[ (v_{j-1}^x - v_{j}^x)^2 + (v_{j-1}^y - v_{j}^y)^2 \right] \\
    &= - \dfrac{v_{j-1}^x - v_j^x}{ \norm[\vec{v}_{j-1} - \vec{v}_{j}] } \\
    &= \dfrac{v_j^x - v_{j-1}^x}{ E^{j-1}_{C} }, 
\end{align*}
and similarly 
\begin{center}
    $
    \frac{\dequ}{ \dequ v_j^x} E^{j}_{C}   = \dfrac{v_j^x - v_{j+1}^x}{ E^{j}_{C} },  \quad 
    \frac{\dequ}{ \dequ v_j^y} E^{j-1}_{C} = \dfrac{v_j^y - v_{j-1}^y}{ E^{j-1}_{C} },  \quad
    \frac{\dequ}{ \dequ v_j^y} E^{j}_{C}   = \dfrac{v_j^y - v_{j+1}^y}{ E^{j}_{C} }.  
    $
\end{center}
We also need 
\begin{align*}
    \frac{\dequ}{ \dequ v_j^x} \left[  \frac{E^{j-1}_C - E^{j-1}_d}{E^{j-1}_C} \right]
    &= \frac{\dequ}{ \dequ v_j^x} \left[  1 - \frac{E^{j-1}_d}{E^{j-1}_C} \right] \\
    &= - E^{j-1}_d \frac{\dequ}{ \dequ v_j^x} \left[ (E^{j-1}_C)^{-1} \right] \\
    &= - E^{j-1}_d (-(E^{j-1}_C)^{-2}) \frac{\dequ}{ \dequ v_j^x} \left[ E^{j-1}_C \right] \\
    &= \frac{E^{j-1}_d}{(E^{j-1}_C)^{2}} \dfrac{v_j^x - v_{j-1}^x}{ E^{j-1}_{C} } \\
    &= \frac{E^{j-1}_d}{(E^{j-1}_C)^{3}} (v_j^x - v_{j-1}^x),
\end{align*}
and, respectively 
\begin{center}
    $
    \frac{\dequ}{ \dequ v_j^x} \left[  \frac{E^{j}_C - E^{j}_d}{E^{j}_C} \right]       = \frac{E^{j  }_d}{(E^{j  }_C)^{3}} (v_j^x - v_{j+1}^x),  \quad 
    \frac{\dequ}{ \dequ v_j^y} \left[  \frac{E^{j-1}_C - E^{j-1}_d}{E^{j-1}_C} \right] = \frac{E^{j-1}_d}{(E^{j-1}_C)^{3}} (v_j^y - v_{j-1}^y),  
    $
\end{center}
\begin{center}
    $
    \frac{\dequ}{ \dequ v_j^y} \left[  \frac{E^{j}_C - E^{j}_d}{E^{j}_C} \right]       = \frac{E^{j  }_d}{(E^{j  }_C)^{3}} (v_j^y - v_{j+1}^y).  
    $
\end{center}
% TODO: do computation d/dv2x [(E1 - Ed)/E1] 


We continue with the computation of the second derivative of the first summand in the first derivative of the edge energy
\begin{align*}
    \nabla_{\vec{v}_j} \cdot &\left[ \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}} \begin{pmatrix} v_{j}^{x} - v_{j-1}^{x} \\[0.5em]  v_{j}^{y} - v_{j-1}^{y}  \end{pmatrix} \right] = \\
    &= \frac{\dequ}{\dequ v_j^x} \left[ \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}} (v_{j}^{x} - v_{j-1}^{x}) \right] 
      + \frac{\dequ}{\dequ v_j^y} \left[ \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}} (v_{j}^{y} - v_{j-1}^{y}) \right] \\
    &= \frac{\dequ}{\dequ v_j^x} \left[ \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}\right] (v_{j}^{x} - v_{j-1}^{x})  
    + \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}} \frac{\dequ}{\dequ v_j^x} \left[(v_{j}^{x} - v_{j-1}^{x})\right] \\
    &\;\;\;\; + \frac{\dequ}{\dequ v_j^y} \left[ \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}\right] (v_{j}^{y} - v_{j-1}^{y}) 
    + \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}} \frac{\dequ}{\dequ v_j^y} \left[ (v_{j}^{y} - v_{j-1}^{y}) \right] \\ 
    &= \frac{E_d^{j-1}}{(E^{j-1}_{C})^3} (v_{j}^{x} - v_{j-1}^{x}) (v_{j}^{x} - v_{j-1}^{x})  
    + \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  \\
    &\;\;\;\; + \frac{E_d^{j-1}}{(E^{j-1}_{C})^3} (v_{j}^{y} - v_{j-1}^{y}) (v_{j}^{y} - v_{j-1}^{y}) 
    + \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  \\ 
    &= \frac{E_d^{j-1}}{(E^{j-1}_{C})^3} (\underbrace{(v_{j}^{x} - v_{j-1}^{x})^2 + (v_{j}^{y} - v_{j-1}^{y})^2}_{\displaystyle = (E^{j-1}_{C})^2}) + \dfrac{2(E^{j-1}_{C}- E_d^{j-1})}{E^{j-1}_{C}} \\
    &= \frac{E_d^{j-1}}{E^{j-1}_{C}} + \dfrac{2(E^{j-1}_{C} - E_d^{j-1})}{E^{j-1}_{C}} \\
    &= \frac{2 E^{j-1}_{C} - E_d^{j-1}}{E^{j-1}_{C}} \\
    &= 2 - \frac{E_d^{j-1}}{E^{j-1}_{C}}.
\end{align*}
The computation for the second summand is analogous and it yields 
\begin{align*}
    \nabla_{\vec{v}_j} \cdot &\left[ \dfrac{E^j_{C} - E_d^{j}}{E^j_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j+1}^{x} \\[0.5em]  v_{j}^{y} - v_{j+1}^{y} \end{pmatrix} \right] = 2 - \frac{E_d^j}{E^j_C}.
\end{align*}
Overall, we get 
\begin{align*}
    \nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} E_2(C) &= 4 - \frac{E_d^{j-1}}{E^{j-1}_{C}} - \frac{E_d^j}{E^j_C}.
\end{align*}
With that result, we can finally compute the searched divergence 
\begin{align*}
    \nabla_C \cdot (\bar{\rho} \, \nabla_C E_2(C))
    &= \sum\limits_{j=1}^{N_V} \nabla_{\vec{v}_j} \cdot (\bar{\rho} \, \nabla_{\vec{v}_j} E_2(C)) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} E_2(C) + \bar{\rho} \, (\nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} E_2(C))\right) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} E_2(C) + \bar{\rho} \, (4 - \frac{E_d^{j-1}}{E^{j-1}_{C}} - \frac{E_d^j}{E^j_C}) \right)   \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} E_2(C)\right) + \bar{\rho} \, (4 N_V - 2 \sum\limits_{j=1}^{N_V} \frac{E_d^j}{E^j_C}),
\end{align*}
because 
\begin{align*}
    \sum\limits_{j=1}^{N_V} (4 - \frac{E_d^{j-1}}{E^{j-1}_{C}} - \frac{E_d^j}{E^j_C}) = 4 N_V - 2 \sum\limits_{j=1}^{N_V} \frac{E_d^j}{E^j_C},
\end{align*}
as we still use circular indexing, e.g. $E^0_C = E^{N_V}_C$.  \\

We can conclude that the mean field density PDE for our DF model with pure edge energy is given by 
\begin{align}
    \frac{\partial \bar{\rho}}{\partial t} + \sum\limits_{j=1}^{N_V} (\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} E_2(C) + \bar{\rho} \, (4 N_V - 2 \sum\limits_{j=1}^{N_V} \frac{E_d^j}{E^j_C}) = 0,
\end{align}
where 
\begin{align*}
    \nabla_{\vec{v}_j} E_2(C) &=  \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j-1}^{x} \\[0.5em]  v_{j}^{y} - v_{j-1}^{y}  \end{pmatrix} 
    + \dfrac{E^j_{C} - E_d^{j}}{E^j_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j+1}^{x} \\[0.5em]  v_{j}^{y} - v_{j+1}^{y} \end{pmatrix}.
\end{align*}

\subsection{DF area energy mean field density} 
Now, we want to compute the mean field density of a DF system with pure area energy 
\begin{align*}
    A_2(C) = \frac{1}{2} |A_{C} - A_d|^2, 
\end{align*}
defined at Equation~\eqref{eq:areaEnergy} with $k=2$.
In order to compute the mean field density of this system, we need to compute 
\begin{align*}
    \nabla_C \cdot (\bar{\rho} \, \nabla_C A_2(C))
    &= \sum\limits_{j=1}^{N_V} \nabla_{\vec{v}_j} \cdot (\bar{\rho} \, \nabla_{\vec{v}_j} A_2(C)) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} A_2(C) + \bar{\rho} \, (\nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} A_2(C))\right).
\end{align*}

The area gradient is given by 
\begin{align*}
    \nabla_{\vec{v}_j} A_2(C) = \dfrac{1}{2} (A_{C} - A_d) \begin{pmatrix} v_{j+1}^{y} - v_{j-1}^{y} \\[0.5em]  v_{j-1}^{x} - v_{j+1}^{x} \end{pmatrix},
\end{align*} 
in Equation~\eqref{gradient:area}. \\
We compute the second derivative 
\begin{align*}
    \nabla_{\vec{v}_j} &\cdot \nabla_{\vec{v}_j} A_2(C) 
    = \nabla_{\vec{v}_j} \cdot \left[ \dfrac{1}{2} (A_{C} - A_d) \begin{pmatrix} v_{j+1}^{y} - v_{j-1}^{y} \\[0.5em]  v_{j-1}^{x} - v_{j+1}^{x} \end{pmatrix} \right] \\[0.5em]
    &= \dfrac{1}{2}  \left( \frac{\partial}{\partial v_j^x} \left[ (A_{C} - A_d)(v_{j+1}^{y} - v_{j-1}^{y}) \right] + \frac{\partial}{\partial v_j^y} \left[ (A_{C} - A_d)(v_{j-1}^{x} - v_{j+1}^{x}) \right] \right) \\[0.5em]
    &= \dfrac{1}{2}  \left((v_{j+1}^{y} - v_{j-1}^{y}) \frac{\partial}{\partial v_j^x} \left[ A_{C} \right] + (v_{j-1}^{x} - v_{j+1}^{x}) \frac{\partial}{\partial v_j^y} \left[ A_{C} \right] \right) \\[0.5em]
    &= \dfrac{1}{2}  \Biggl(  (v_{j+1}^{y} - v_{j-1}^{y}) \frac{\partial}{\partial v_j^x} \left[ \frac{1}{2}\sum\limits_{l = 1}^{N} (v_l^{x} v_{l+1}^{y} - v_{l+1}^{x} v_l^{y})\right] + \\
    & \hspace{0.7cm} + (v_{j-1}^{x} - v_{j+1}^{x}) \frac{\partial}{\partial v_j^y} \left[\frac{1}{2}\sum\limits_{l = 1}^{N} (v_l^{x} v_{l+1}^{y} - v_{l+1}^{x} v_l^{y})  \right] \Biggr) \\[0.5em]
    &= \dfrac{1}{2}  \Biggl(  (v_{j+1}^{y} - v_{j-1}^{y}) \frac{1}{2}\frac{\partial}{\partial v_j^x} \left[ (v_j^x v_{j+1}^y - v_{j+1}^x v_j^y) + (v_{j-1}^x v_j^y - v_j^x v_{j-1}^y) \right] + \\
    & \hspace{0.7cm} + (v_{j-1}^{x} - v_{j+1}^{x}) \frac{1}{2}\frac{\partial}{\partial v_j^y} \left[(v_j^x v_{j+1}^y - v_{j+1}^x v_j^y) + (v_{j-1}^x v_j^y - v_j^x v_{j-1}^y)  \right] \Biggr) \\[0.5em]
    &= \dfrac{1}{4}  \left(  (v_{j+1}^{y} - v_{j-1}^{y}) \left( v_{j+1}^y - v_{j-1}^y \right) +  (v_{j-1}^{x} - v_{j+1}^{x}) (v_{j-1}^{x} - v_{j+1}^{x}) \right) \\[0.5em]
    &= \dfrac{1}{4} \left(  (v_{j+1}^{y} - v_{j-1}^{y})^2 +  (v_{j-1}^{x} - v_{j+1}^{x})^2 \right) \\[0.5em]
    &= \dfrac{1}{4} \norm[\vec{v}_{j+1} - \vec{v}_{j-1}]^2.
\end{align*}

With this computation, we can write down the divergence $\nabla_C \cdot (\bar{\rho} \, \nabla_C A_2(C))$ as 
\begin{align*}
    \nabla_C \cdot (\bar{\rho} \, \nabla_C A_2(C))
    &= \sum\limits_{j=1}^{N_V} \nabla_{\vec{v}_j} \cdot (\bar{\rho} \, \nabla_{\vec{v}_j} A_2(C)) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} A_2(C) + \bar{\rho} \, (\nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} A_2(C))\right) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} A_2(C) + \dfrac{\bar{\rho}}{4} \, \norm[\vec{v}_{j+1} - \vec{v}_{j-1}]^2 \right). \\
\end{align*}

Overall, we get the mean field PDE for the isolated area energy given as 
\begin{align}
    \frac{\partial \bar{\rho}}{\partial t} + \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} A_2(C) + \dfrac{\bar{\rho}}{4} \, \norm[\vec{v}_{j+1} - \vec{v}_{j-1}]^2 \right) = 0,
\end{align}
where 
\begin{align*}
    \nabla_{\vec{v}_j} A_2(C) = \dfrac{1}{2} (A_{C} - A_d) \begin{pmatrix} v_{j+1}^{y} - v_{j-1}^{y} \\[0.5em]  v_{j-1}^{x} - v_{j+1}^{x} \end{pmatrix}.
\end{align*} 

\subsection{DF interior angle energy mean field density} 
In this subsection, we study the case with pure interior angle energy applied, i.e. 
\begin{align*}
    I_2(C) = \sum\limits_{j=1}^{N_V} \frac{1}{2}| I^j_{C} - I^{j}_d |^2, 
\end{align*}
from Equation~\eqref{eq:intAngleEnergy} with $k=2$. \\
Next, we are looking for  
\begin{align*}
    \nabla_C \cdot (\bar{\rho} \, \nabla_C I_2(C))
    &= \sum\limits_{j=1}^{N_V} \nabla_{\vec{v}_j} \cdot (\bar{\rho} \, \nabla_{\vec{v}_j} I_2(C)) \\
    &= \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} I_2(C) + \bar{\rho} \, (\nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} I_2(C))\right).
\end{align*}
In Chapter~\ref{dynamics}, we already computed the first derivative as 
\begin{align*}
    \begin{split}
        \nabla_{\vec{v}_j} I_2(C) &=  (I^{j-1}_{C} - I^{j-1}_d) \left( 
                - \frac{1}{\norm[\vec{v}_{j} - \vec{v}_{j-1}]^{2}} \begin{pmatrix}
                    v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
                    v_{j}^{x} - v_{j-1}^{x}
                \end{pmatrix} 
            \right) \\[0.5em] 
        &+ (I^{j}_{C} - I^{j}_d) \Biggl( 
            \frac{1}{\norm[\vec{v}_{j-1} - \vec{v}_j]^{2}} \begin{pmatrix}
            v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j-1}^{x}
            \end{pmatrix} \\
        &\hspace{2cm} - \frac{1}{\norm[\vec{v}_{j+1} - \vec{v}_j]^2} \begin{pmatrix}
            v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j+1}^{x}
            \end{pmatrix} 
            \Biggr) \\[0.5em] 
        &+ (I^{j+1}_{C} - I^{j+1}_d) \left( 
            \frac{1}{\norm[\vec{v}_{j} - \vec{v}_{j+1}]^2} \begin{pmatrix}
            v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j+1}^{x}
            \end{pmatrix} 
            \right), %\\[0.5em] 
    \end{split}
\end{align*}
in Equation~\eqref{gradient:angle}. \\

TODO: write down computation for second derivative. 
We get the second derivative 
\begin{align*}
    \nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} I_2(C) = \frac{2}{E_{j-1}^2} &\left[ 1 + 2(I_C^{j-1} - I_d^{j-1} + I_C^{j} - I_d^{j})(v_j^x - v_{j-1}^x)(v_j^y - v_{j-1}^y) \right] \\
    + \frac{2}{E_{j}^2} &\left[ 1 - 2 (I_C^{j} - I_d^{j} + I_C^{j+1} - I_d^{j+1})(v_{j}^x - v_{j+1}^x)(v_j^y - v_{j+1}^y) \right] \\
    -  \frac{2}{E_{j-1}^2 E_{j}^2} &\left[ (v_j^x - v_{j-1}^x)(v_{j}^x - v_{j+1}^x) + (v_j^y - v_{j-1}^y)(v_j^y - v_{j+1}^y)  \right].
\end{align*}

We can conclude the mean field PDE for pure interior angle energy 
\begin{align}
    \frac{\partial \bar{\rho}}{\partial t} + \sum\limits_{j=1}^{N_V} \left((\nabla_{\vec{v}_j} \cdot \bar{\rho}) \cdot \nabla_{\vec{v}_j} I_2(C) + \bar{\rho}\; \nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} I_2(C) \right) = 0,
\end{align}
where 
\begin{align*}
    \nabla_{\vec{v}_j} I_2(C) &=  (I^{j-1}_{C} - I^{j-1}_d) \left( 
            - \frac{1}{\norm[\vec{v}_{j} - \vec{v}_{j-1}]^{2}} \begin{pmatrix}
                v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
                v_{j}^{x} - v_{j-1}^{x}
            \end{pmatrix} 
        \right) \\[0.5em] 
    &+ (I^{j}_{C} - I^{j}_d) \Biggl( 
        \frac{1}{\norm[\vec{v}_{j-1} - \vec{v}_j]^{2}} \begin{pmatrix}
        v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
        v_{j}^{x} - v_{j-1}^{x}
        \end{pmatrix} \\
    &\hspace{2cm} - \frac{1}{\norm[\vec{v}_{j+1} - \vec{v}_j]^2} \begin{pmatrix}
        v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
        v_{j}^{x} - v_{j+1}^{x}
        \end{pmatrix} 
        \Biggr) \\[0.5em] 
    &+ (I^{j+1}_{C} - I^{j+1}_d) \left( 
        \frac{1}{\norm[\vec{v}_{j} - \vec{v}_{j+1}]^2} \begin{pmatrix}
        v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
        v_{j}^{x} - v_{j+1}^{x}
        \end{pmatrix} 
        \right), %\\[0.5em] 
\end{align*} 
and 
\begin{align*}
    \nabla_{\vec{v}_j} \cdot \nabla_{\vec{v}_j} I_2(C) = \frac{2}{E_{j-1}^2} &\left[ 1 + 2(I_C^{j-1} - I_d^{j-1} + I_C^{j} - I_d^{j})(v_j^x - v_{j-1}^x)(v_j^y - v_{j-1}^y) \right] \\
    + \frac{2}{E_{j}^2} &\left[ 1 - 2 (I_C^{j} - I_d^{j} + I_C^{j+1} - I_d^{j+1})(v_{j}^x - v_{j+1}^x)(v_j^y - v_{j+1}^y) \right] \\
    -  \frac{2}{E_{j-1}^2 E_{j}^2} &\left[ (v_j^x - v_{j-1}^x)(v_{j}^x - v_{j+1}^x) + (v_j^y - v_{j-1}^y)(v_j^y - v_{j+1}^y)  \right].
\end{align*}