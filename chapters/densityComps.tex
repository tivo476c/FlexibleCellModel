\section{Density computations} \label{density}

In the previous chapter, we employed Monte Carlo simulations to validate the microscopic cell model and to illustrate the qualitative behaviour emerging from the underlying gradient flow dynamics. 
While such simulations provide valuable empirical insight, they do not yet reveal the macroscopic, continuum level structure of the system. \\
In this chapter, we therefore develop a systematic framework to pass from individual cell dynamics to a description in terms of probability measures and densities. 
We introduce the empirical measure associated with large ensembles of simulated cells, explain its convergence to the first marginal of the $N_C$ cell system, and analyse the subsequent mean-field limit as $N_C \rightarrow \infty$. \\
%TODO: in the end really write down what we have done: 
This leads naturally to a deterministic transport equation for the limiting cell density, which provides a mathematically transparent interpretation of the collective dynamics. 
We illustrate this approach with an explicit low dimensional needle cell example. 
Afterwards, we compute the mean field PDEs for our DF model with sorely the area, edge or interior angle force applied, respectively. 
Unfortunately, we did not manage to do the same for our interaction term in this thesis, as there was not enough time. 
%now introduce empirical measure: 
For our point particle monte carlo simulations, we can define the empirical measure 
\begin{align*}
    &\mu^{(N_C, N_S)}_t: \mathcal{B}(\R^2) \: \longrightarrow \: [0,1],  \\
    A \: \longmapsto \: &\mu^{(N_C, N_S)}_t(A) = \frac{1}{N_C N_S} \sum\limits_{i=1}^{N_C} \sum\limits_{s=1}^{N_S} \delta_{\vec{x}_i^{\:(s)}(t)}(A),
\end{align*}
where $N_C$ is again the number of cells in each simulation, $N_S$ denotes the number of simulations in the Monte Carlo simulation and $\vec{x}_i^{\:(s)}(t) \in \Omega \subset \R^2$ is the location of point particle $1 \leq i \leq N_C$ in simulation $1 \leq s \leq N_S$ and at time $t \in [0, T]$.   \\
$\mathcal{B}(\R^2)$ is the Borel sigma-algebra on $\R^2$ and \( \delta_{\vec{x}_i(t)} \) denotes the Dirac measure: 
\begin{align*}
    &\delta_{\vec{x}_i(t)}: \mathcal{B}(\R^2) \: \longrightarrow \: \{0,1\},  \\
    A \: \longmapsto \: &\delta_{\vec{x}_i(t)}(A) = \begin{cases}
        1 & \text{if } \vec{x}_i(t) \in A, \\
        0 & \text{if } \vec{x}_i(t) \notin A.
   \end{cases}
\end{align*}
For any test function \( \phi \in C_c^\infty(\R^2) \), the Dirac measure satisfies
\[
\int_{\R^2} \phi(x) \dequ \delta_{\vec{x}_i(t)}(x) = \phi(\vec{x}_i(t)).
\]
For a set $A \in \mathcal{B}(\mathbb{R}^2)$, the quantity $\mu^{(N_C, N_S)}_t(A)$ denotes the relative proportion of the $N_C$ particles that lie in $A$ at time $t$, averaged over all $N_S$ simulations.\\
The heatmaps in Chapter~\ref{sanitycheck} are obtained by evaluating this empirical measure on a family of subsets $\{A_{ij}\}_{i,j=1}^{N_H}$, where $N_H^2$ is the number of sub squares into which we partition the domain $\Omega = [-0.5, 0.5]^2$.  
Each subsquare $A_{ij}$ has side length $\tfrac{1}{N_H}$, and increasing $N_H$ yields an increasingly fine spatial resolution of~$\Omega$.\\
If, in addition, we let $N_S \to \infty$, then by the Central Limit Theorem the empirical heatmaps converge to their expectation, which coincides with the first marginal distribution of the system, since the simulations are independent and identically distributed.  
In our computations we used $10\,000$ simulations to ensure a reliable numerical approximation of this first marginal. \\

There is also a further limit to consider: the mean field limit. 
Here, we let the number of cells $N_C \rightarrow \infty$. 
In the mean field limit, we can study the transition from the microscopic model view, that uses a finite number of cells, $N_C < \infty$, to a macroscopic model view where we consider the whole system's density without individual cells. \\
Figure~\ref{fig:muTransition} illustrates how empirical particle distributions converge towards their underlying mean field density as the number of particles increases.  
The first three panels depict empirical measures obtained from samples of size $N_C \in \{20, 200, 20\,000\}$, drawn independently from the same Gaussian distribution $\mathcal{N}_2((0,0), 0.09^2 I_2)$.
To visualise these empirical measures, the domain \( \Omega = [-0.5,0.5]^2 \) is partitioned into \(50 \times 50\) sub squares, on which the empirical measure
\[
    \mu^{N_C}(A) = \frac{1}{N_C} \sum_{i=1}^{N_C} \delta_{\vec{x}_i}(A)
\]
is evaluated and displayed as a heatmap. \\
As the particle number grows, the empirical distribution becomes progressively smoother and more faithful to the true underlying density.  
For small \(N_C\), random fluctuations dominate the visual appearance, while for larger \(N_C\) these fluctuations average out, and the heatmap increasingly resembles the continuous Gaussian density shown in the fourth panel.  \\

\begin{figure}[b!]
	\begin{center}
		\includegraphics[width=15cm]{density/muplot_combined.png}
		\caption{Empirical measures for increasing particle numbers \(N_C \in \{20, 200, 20\,000\}\), compared with the limiting density \( \mathcal{N}_2((0,0), 0.09^2 \cdot I_2) \) shown in the fourth panel.  
        Particles are sampled i.i.d.\ from the same distribution, and the empirical measure \( \mu^{N_C} \) is visualised on a \(50 \times 50\) grid of sub squares.  
        As \(N_C\) increases, the empirical heatmaps become smoother and converge to the Gaussian density, demonstrating the transition towards the mean field limit.  
        A consistent colour scale allows direct comparison across all subplots.
        }
		\label{fig:muTransition}
	\end{center}
\end{figure}

For the following discussion, we assume that the first marginal distributions of the DF model converge to a mean field density, that is,
\[
    \rho^{N_C} \xrightarrow{N_C \to \infty} \bar{\rho}.
\]
In the preceding chapters, we wrote $\rho$ for the first marginal, as the mean field limit was not under consideration.  
To emphasise the dependence on the number of cells $N_C$, we adopt the notation $\rho^{N_C}$ throughout this chapter. \\
A rigorous analysis establishing this convergence remains an interesting direction for future work. \\ 

% now: computation of mean field density PDE 
Next, we will show how the PDE for the mean field density temporal evolution can be computed generally for a point particle model, if the particle dynamic is given by the gradient flow of a given energy. 
For $N_C$ point particles $\vec{x}_i(t) \in \R^2$, we use a cell wise energy  
\begin{align*}
    E: \R^{2} \: &\longrightarrow \:  \R, \\ 
    \vec{x} \: &\longmapsto \: E(\vec{x}).
\end{align*}

We define the dynamic of a particle $\vec{x}_i$ via \\
\[ 
    \dfrac{\dequ \vec{x}_i(t)}{\dequ t} = - \nabla E(\vec{x}_i(t)) \in \R^{2}, \quad 1 \leq i \leq N_C. 
\]
We consider the empirical measure 
\[
    \mu_t^{N_C}(A) = \tfrac{1}{N_C} \sum\limits_{i=1}^{N_C} \delta_{\vec{x}_i(t)}(A)
\]
Let $\phi \in C_c^{\infty}(\R^{2}, \R)$ be a test function with gradient field $ \nabla \phi : \R^2 \rightarrow \R^2$. \\
We assume that $\mu_t^{N_C}$ has density $\rho_t^{N_C}$ ($\dequ \mu_t^{N_C} = \rho_t^{N_C}(x) \dequ x $) and we have convergence 
\begin{align*}
    \rho_t^{N_C} \xrightarrow{N_C \to \infty} \bar{\rho}_t.
\end{align*}  
First, we consider 
\begin{align}
    \begin{split}
        \frac{\dequ}{\dequ t} \int \phi(x) \: \dequ \mu^{N_C}_t
        &= \frac{\dequ}{\dequ t} \int \phi(x) \: \rho_t^{N_C}(x) \: \dequ x \\
        &\xrightarrow{N_C \rightarrow \infty} \frac{\dequ}{\dequ t} \int \phi(x) \: \bar{\rho}_t(x) \: \dequ x \\
        &= \int \phi(x) \,\frac{\partial}{\partial t} \left[\bar{\rho}_t(x)\right] \: \dequ x,
    \end{split}
    \label{equ:leftSideMeanFieldPDE}
\end{align}
using first the density $\rho_t^{N_C}$ of $\mu_t^{N_C}$ and then convergence $\rho_t^{N_C} \xrightarrow{N_C \to \infty} \bar{\rho}_t$. \\
Then, we use the definition of the empirical measure to obtain 
\begin{align}
    \begin{split}
        \frac{\dequ}{\dequ t} \int \phi(x) \: \dequ \mu^{N_C}_t
        &= \frac{\dequ}{\dequ t} \left[\frac{1}{N_C} \sum\limits_{i=1}^{N_C}  \phi(\vec{x}_i^{\: (s)}(t))\right] \\
        &= - \frac{1}{N_C} \sum\limits_{i=1}^{N_C} \nabla \phi(\vec{x}_i^{\: (s)}(t)) \cdot \nabla E(\vec{x}_i^{\: (s)}(t)) \\
        &= - \int \nabla \phi(x) \cdot \nabla E(x) \: \dequ \mu^{N_C}_t \\
        &= - \int \nabla \phi(x) \cdot \nabla E(x) \: \rho_t^{N_C}(x) \: \dequ x \\
        &\xrightarrow{N_C \rightarrow \infty} - \int \nabla \phi(x) \cdot \nabla E(x) \: \bar{\rho}_t(x) \: \dequ x \\
        &= \int \phi(x)  \nabla \cdot ( \bar{\rho}_t(x) \nabla E(x)) \: \dequ x. \\
    \end{split}
    \label{equ:rightSideMeanFieldPDE}
\end{align}
We consider the difference from Equations~\eqref{equ:leftSideMeanFieldPDE} and \eqref{equ:rightSideMeanFieldPDE} for $N_C \rightarrow \infty$
\begin{align*}
    0 
    &= \int \phi(x) \,\frac{\partial}{\partial t} \left[\bar{\rho}_t(x)\right] \: \dequ x - \int \phi(x)  \nabla \cdot ( \bar{\rho}_t(x) \nabla E(x)) \: \dequ x \\
    &= \int \phi(x) \left( \frac{\partial}{\partial t} \left[\bar{\rho}_t(x)\right] -  \nabla \cdot ( \bar{\rho}_t(x) \nabla E(x)) \right) \: \dequ x.
\end{align*}

As this holds true for any $\phi \in C_c^{\infty}(\R^{2}, \R)$, we obtain the mean field PDE 
\begin{align}
    \frac{\partial \bar{\rho}_t(x)}{\partial t} -  \nabla \cdot ( \bar{\rho}_t(x) \nabla E(x)) = 0.
    \label{equ:meanFieldDerivation}
\end{align}
For a force function $F(C) = - \nabla_C E(C)$, the we get the formulation
\begin{align}
    \frac{\partial \bar{\rho}_t(x)}{\partial t} +  \nabla \cdot ( \bar{\rho}_t(x) F(x)) = 0.
\end{align}


\subsection{1d needles example}
% TODOs: formulate everything, figure captions, formatting
In order to demonstrate how the preceding computations can be applied in practice, we begin with a lower dimensional example. 
In this setting, each cell consists of two vertices situated in one spatial dimension, 
\begin{align*}
    C = \{v_1, v_2\}, \quad v_1, v_2 \in \R 
\end{align*}
where we assume $v_1 \neq v_2$ and that their ordering remains fixed throughout the simulation. 
This ensures that cells do not attain negative length. \\
Our dynamic naturally fulfils this condition, as we use the cell wise energy 
\begin{align*}
    E(C) = \tfrac{1}{2} \left| |v_1 - v_2| - E_d  \right|^2,
\end{align*}
where $E_d$ is the desired edge length of each cell. 
This energy lets each needle cell to recover a length of $E_d$. \\
Applying gradient flow dynamics yields
\begin{align*}
    \frac{\dequ v_1}{\dequ t} 
    &= - \nabla_{v_1} E(C) \\
    &= - \nabla_{v_1} \tfrac{1}{2}| |v_1 - v_2| - E_d |^2 \\
    &= - (|v_1 - v_2| - E_d) \nabla_{v_1} |v_1 - v_2|  \\
    &= - sgn(v_1 - v_2) (|v_1 - v_2| - E_d),   \\
\end{align*}
and 
\begin{align*}
    \frac{\dequ v_2}{\dequ t} 
    &=  sgn(v_1 - v_2) (|v_1 - v_2| - E_d).  \\
\end{align*}
The resulting cell dynamics take the compact form
\begin{align*}
    \frac{\partial C}{\partial t} = - \nabla_C E(C) =F(C) = \underbrace{sgn(v_1 - v_2) (|v_1 - v_2| - E_d)}_{\displaystyle = \alpha} \begin{pmatrix}
        -1 \\ 
        1
    \end{pmatrix}.
\end{align*}

For the subsequent derivation we require the computations 
\begin{align*}
    \nabla_{v_1} \cdot \alpha 
    &= \nabla_{v_1} \cdot (sgn(v_1 - v_2) (|v_1 - v_2| - E_d)) \\
    &= (\nabla_{v_1} \cdot sgn(v_1 - v_2)) (|v_1 - v_2| - E_d) 
      +  sgn(v_1 - v_2)(\nabla_{v_1} \cdot (|v_1 - v_2| - E_d) ) \\
    &= 0 + sgn(v_1 - v_2)(\nabla_{v_1} \cdot (|v_1 - v_2|) ) \\
    &= sgn(v_1 - v_2) sgn(v_1 - v_2) \\
    &= 1,
\end{align*}
and 
\begin{align*}
    \nabla_{v_2} \cdot \alpha 
    &= \nabla_{v_2} \cdot (sgn(v_1 - v_2) (|v_1 - v_2| - E_d)) \\
    &= (\nabla_{v_2} \cdot sgn(v_1 - v_2)) (|v_1 - v_2| - E_d) 
      +  sgn(v_1 - v_2)(\nabla_{v_2} \cdot (|v_1 - v_2| - E_d) ) \\
    &= 0 + sgn(v_1 - v_2)(\nabla_{v_2} \cdot (|v_1 - v_2|) ) \\
    &= sgn(v_1 - v_2) (- sgn(v_1 - v_2)) \\
    &= -1,
\end{align*}

With these identities at hand, we compute the divergence
\begin{align*}
    \nabla_C \cdot (\bar{\rho} F) 
    &= \nabla_{v_1} \cdot (\bar{\rho} F_1)  + \nabla_{v_2} \cdot (\bar{\rho} F_2) \\
    &= (\nabla_{v_1} \cdot \bar{\rho}) F_1 + \bar{\rho} (\nabla_{v_1} \cdot F_1) + (\nabla_{v_2} \cdot \bar{\rho}) F_2 + \bar{\rho} (\nabla_{v_2} \cdot F_2) \\
    &= - (\nabla_{v_1} \cdot \bar{\rho}) \alpha - \bar{\rho} (\nabla_{v_1} \cdot \alpha) + (\nabla_{v_2} \cdot \bar{\rho}) \alpha + \bar{\rho} (\nabla_{v_2} \cdot \alpha) \\
    &= - (\nabla_{v_1} \cdot \bar{\rho}) \alpha - \bar{\rho} + (\nabla_{v_2} \cdot \bar{\rho}) \alpha - \bar{\rho} \\
    &= - 2 \bar{\rho} + \alpha(- \nabla_{v_1} \cdot \bar{\rho} + \nabla_{v_2} \cdot \bar{\rho})   \\
\end{align*}
where $F = (F_1, F_2)^T$.  \\
Consequently, in the mean field limit $N_C \rightarrow \infty$, the density $\bar{\rho}$ satisfies
\begin{align*}
    \frac{\partial \bar{\rho}}{\partial t} + 2 \bar{\rho} - \alpha(- \nabla_{v_1} \cdot \bar{\rho} + \nabla_{v_2} \cdot \bar{\rho}) = 0,
\end{align*}
according to Equation~\eqref{equ:meanfieldPDE}. \\
To illustrate this model, we present two corresponding simulations.  
First, we consider a finite system of $N_C = 400$ needle cells.  
Each cell is initialised according to
\begin{center}
    $
    C_i = (v^{i}_1, v^{i}_2) \sim \mathcal{N}_2((0.5,0.5)^T, 0.09^2 \cdot I_2), \quad 1 \leq i \leq 400.
    $
\end{center}
We then evolve the system under the dynamics
\begin{align*}
    \frac{\partial C}{\partial t} = F(C) = sgn(v_1 - v_2) (|v_1 - v_2| - E_d)(-1, 1)^T,
\end{align*}
using a desired edge length of $E_d = 0.2$.  
The resulting ODE system is integrated with an explicit Euler method using a time step of $\Delta t = 10^{-3}$ over the interval $[0,1]$, giving $100$ time steps. \\
Figure~\ref{fig:needle400} visualises the evolution of the one dimensional needle cell system. 
Each cell is represented by a blue point in the $(v_1,v_2)$ plane, where the horizontal axis corresponds to the position of the first vertex and the vertical axis to that of the second vertex. 
Such a representation is only possible in this lower-dimensional setting, since the full vertex configuration of a cell can be embedded in $\R^2$. \\
At initial time, the $N_C = 400$ cells are sampled from $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$. 
As time progresses, the dynamics drive each cell towards its desired edge length $E_d = 0.2$. 
In the scatter plot, this manifests as a gradual migration of points towards the two diagonal lines defined by $|v_1 - v_2| = 0.2$, corresponding to cells whose vertex separation has achieved the prescribed value. 
By the final time, all cells lie precisely on these two diagonals, confirming that the system converges to a configuration in which every cell has relaxed to the target length. \\

Subsequently, we examine the associated mean field dynamics.  
We choose an initial condition given by $\mathcal{N}_2((0.5,0.5)^T, 0.09^2 \cdot I_2)$ on the domain $\Omega = [0.0, 1.0]^2$ and evolve it using the PDE
\begin{align*}
    \frac{\partial \bar{\rho}}{\partial t}  = \nabla_{v_1} \cdot (- \bar{\rho} \alpha)  + \nabla_{v_2} \cdot (\bar{\rho} \alpha),
\end{align*}
which arises from the earlier derivation of the density evolution equation.  
The discretisation is given by
% TODO: fix this
\begin{align*}
    \Omega \: &\longrightarrow \: \{A_{ij}\}_{i,j = 1}^{500} \text{ sub squares}, \\[0.5em]
    \bar{\rho} \: &\longrightarrow \: \bar{\rho}_{ij}^{\: k} \text{ density value on } A_{ij} \text{ at time step } k \in \N, \\[0.5em]
    \partial_t \bar{\rho} \: &\longrightarrow \: \frac{\bar{\rho}_{ij}^{\: k+1} - \bar{\rho}_{ij}^{\: k}}{\Delta t}, \\[0.5em] 
    \alpha \: &\longrightarrow \: \alpha_{ij}^k \text{ value on } A_{ij} \text{ at time step } k \in \N, \\[0.5em]
    \nabla_{v_1} \cdot (- \bar{\rho} \alpha) \: &\longrightarrow \: \frac{- \bar{\rho}_{i,j+1}^{\: k} \alpha_{i,j+1}^k + \bar{\rho}_{i,j-1}^{\: k} \alpha_{i,j-1}^k}{2 \Delta x},  \\[0.5em]
    \nabla_{v_2} \cdot (\bar{\rho} \alpha) \: &\longrightarrow \: \frac{ \bar{\rho}_{i+1,j}^{\: k} \alpha_{i+1,j}^k - \bar{\rho}_{i-1,j}^{\: k} \alpha_{i-1,j}^k}{2 \Delta x}, 
\end{align*}
with grid spacing $\Delta x = \tfrac{1}{500}$.  
\FloatBarrier
\begin{figure}[b!]
    \centering
    
    \begin{tabular}{ccc}
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t1.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t2.png} &  
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t3.png} \\   

        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t4.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t5.png} &  
        \includegraphics[width=0.3\textwidth]{density/needles/histograms/1/histogram_t6.png} \\    
    \end{tabular}

    \caption{Scatter plots showing the evolution of $N_C = 400$ one dimensional needle cells at times $t \in \{0.0, 0.2, \ldots, 1.0\}$. 
    Each blue point represents a single cell, with the horizontal axis indicating the location of the first vertex $v_1$ and the vertical axis the location of the second vertex $v_2$. 
    The initial conditions are drawn from $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$. The dynamics aim to achieve a desired edge length of $E_d = 0.2$, corresponding to the two diagonal lines defined by $|v_1 - v_2| = 0.2$.}

	\label{fig:needle400}    
\end{figure}
\newpage
\FloatBarrier
\begin{figure}[h!]
    \centering
    
    \begin{tabular}{ccc}
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t1-equal-scale.png} &    
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t2-equal-scale.png} &   
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t3-equal-scale.png} \\   

        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t4-equal-scale.png} & 
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t5-equal-scale.png} &   
        \includegraphics[width=0.3\textwidth]{density/needles/density-evo/alphamu/equal scale/density-t6-equal-scale.png} \\  
    \end{tabular}

    \caption{Evolution of the mean field density starting from the initial distribution $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$ on the domain $[0,1]^2$. 
    The PDE dynamics transport the density towards the two diagonal lines defined by $|v_1 - v_2| = 0.2$, along which the mass becomes concentrated over time. 
    The plots display the density at successive time instances and include small oscillations between the diagonals arising from the central-difference discretisation; these could be removed through an upwind treatment of the spatial gradients.}
	\label{fig:needle-limit}    
\end{figure}



Figure~\ref{fig:needle-limit} illustrates the evolution of the cell density in the mean field limit. 
The initial distribution is given by $\mathcal{N}_2((0.5,0.5), 0.09^2 \cdot I_2)$ on the domain $[0,1]^2$, forming a concentrated region in the centre of the domain. 
Under the action of the mean field PDE, the density is gradually transported towards the two diagonal lines characterised by $|v_1 - v_2| = 0.2$, mirroring the behaviour observed in the finite-particle simulation from Figure~\ref{fig:needle400}. 
As time evolves, the solution develops sharp ridges along these diagonals, and by the final time almost all mass is concentrated on there, indicating convergence towards the desired edge length in the continuum description.

During the evolution, small oscillations appear in the region between the two diagonals. 
These artefacts are purely numerical and originate from the central difference discretisation used for the spatial derivatives. They can be removed by employing an upwind scheme, which would provide the correct directional bias in the discretisation of the fluxes and thereby suppress non-physical oscillations. 

% reference to hard disc exclusion
Both simulations exhibit exclusion effects that closely resemble the behaviour observed in the earlier hard disc model shown in Figure~\ref{fig:hardsphere}.
In the hard disc example, the diagonal region of the domain was inaccessible because any placement of the second disc in that area would necessarily lead to overlap with the first disc. 
This exclusion was enforced explicitly: overlap was prohibited both by the initial configuration and by the dynamics, which strictly prevented discs from entering the forbidden region. \\ 
The geometric volume exclusion in the hard disc system corresponds to the desired state constraint in the needle model: whereas discs must avoid overlaps, needles are driven toward configurations in which their length equals $E_d$, and both mechanisms create analogous forbidden regions in the state space.
The needle model does not impose such exclusions a priori. 
Initially, needle cell configurations with lengths unequal to $E_d$ are allowed. 
Nevertheless, the dynamics, driven by the energy term
\[
    E(C) = \tfrac{1}{2} ||v_1 - v_2| - E_d |^2 ,
\]
naturally steer the system toward states where the needle length matches $E_d$. 
As the evolution proceeds, the density gradually depletes along the diagonal region of the $(v_1, v_2)$ space, reproducing the same `forbidden' diagonal line that appeared in the hard-disc case. \\
Thus, while the hard disc model exhibits a hard exclusion (geometric non-overlap), the needle system develops a soft exclusion: the dynamics energetically penalize undesirable configurations until the system self organises into a feasible state.


\subsection{DF model mean field PDE} \label{subsection:dfMeanFieldPDE}
- bridge from needle example to mean field DF PDE
Now, we want to apply the computation for PDE~\eqref{equ:meanFieldDerivation} on our DF model.
Therefore, we adapt our empirical measure. 
In the DF model, we model cells as polygons with $N_V \in \N$ vertices. 
Thus, we need to use $\delta_{C_i}$ that uses high dimensional subsets $A \subset \R^{2 N_V}$, i.e.
\begin{align*}
    &\mu^{(N_C, N_V)}_t: \mathcal{B}(\R^{2 N_V}) \: \longrightarrow \: [0,1],  \\
    A \: \longmapsto \: &\mu^{(N_C, N_V)}_t(A) = \frac{1}{N_C} \sum\limits_{i=1}^{N_C}  \delta_{C_i(t)}(A),
\end{align*}
where $C_i(t) = (\vec{v}^{\:i}_1, \ldots, \vec{v}^{\:i}_{N_V})$ is cell $i$ at time $t$. \\ 
We use a cell wise energy 
\begin{align*}
    E: \R^{2 N_V} \rightarrow \R, 
\end{align*}
with gradient 
\begin{align*}
    \nabla E: \R^{2 N_V} \rightarrow \R^{2 N_V}.
\end{align*}
Later on, we want to insert the three shape preserving energies, i.e. the area, edge and interior angle energy, that all have the above attributes.
We can derive the mean field PDE for this setup as follows. 
Let $\phi \in C_c^{\infty}(\R^{2N_V}, \R)$ be a test function on the higher dimensional space $\R^{2N_V}$.
We assume that the empirical measure $\mu^{(N_C, N_V)}_t$ has density $\rho_t^{(N_C, N_V)}$ that converges to the mean field density $\bar{\rho}_t^{\:N_V}$, as $N_C \rightarrow \infty$.
Similarly to the calculation at the beginning of this chapter, we observe 
\begin{align*}
    \begin{split}
        \frac{\dequ}{\dequ t} \int \phi(C) \: \dequ \mu^{(N_C, N_V)}_t
        &= \frac{\dequ}{\dequ t} \int \phi(C) \: \rho_t^{(N_C, N_V)}(C) \: \dequ C \\
        &\xrightarrow{N_C \rightarrow \infty} \frac{\dequ}{\dequ t} \int \phi(C) \: \bar{\rho}_t^{\:N_V}(C) \: \dequ C \\
        &= \int \phi(C) \,\frac{\partial}{\partial t} \left[\bar{\rho}_t^{\:N_V}(C)\right] \: \dequ C,
    \end{split}
\end{align*}
and 
\begin{align*}
    \frac{\dequ}{\dequ t} \int \phi(C) \: \dequ \mu^{(N_C, N_V)}_t
    &= \frac{\dequ}{\dequ t} \left[\frac{1}{N_C} \sum\limits_{i=1}^{N_C} \phi(C_i(t))\right] \\
    &= - \frac{1}{N_C} \sum\limits_{i=1}^{N_C}  \nabla \phi(C_i(t)) \cdot \nabla E(C_i(t)) \\
    &= - \int \nabla \phi(C) \cdot \nabla E(C) \: \dequ \mu^{(N_C, N_V)}_t \\
    &= - \int \nabla \phi(C) \cdot \nabla E(C) \: \rho_t^{(N_C, N_V)}(C) \: \dequ C \\
    &\xrightarrow{N_C \rightarrow \infty} - \int \nabla \phi(C) \cdot \nabla E(C) \: \bar{\rho}_t^{\:N_V}(C) \: \dequ C \\
    &= \int \phi(C)  \nabla \cdot ( \bar{\rho}_t^{\:N_V}(C) \nabla E(C)) \: \dequ C. \\
\end{align*}
We can conclude, with the same derivation as before, that   
\begin{align}
    \frac{\partial \bar{\rho}_t^{\:N_V}(C)}{\partial t} - \nabla \cdot (\bar{\rho}_t^{\:N_V}(C) \nabla E(C)) = 0.
    \label{equ:meanfieldPDE}
\end{align}

Now, we want to consider our energies individually, before we take a look at a combined system. 

First, we consider pure scaled \textbf{area energy}, i.e.
\begin{align*}
    E_A(C) = \alpha_{A} A_2(C) = \frac{\alpha_{A}}{2} |A_{C} - A_d|^2, 
\end{align*}
with $A_2(C)$ defined at Equation~\eqref{eq:areaEnergy} with $k=2$. \\
This energy has the gradient 
\begin{align*}
    \nabla_C E_A(C) 
    &=  \begin{pmatrix}  \nabla_{\vec{v}_1} \\ \vdots \\  \nabla_{\vec{v}_{N_V}} \end{pmatrix} E_A(C),
\end{align*}
with 
\begin{align*}
    \nabla_{\vec{v}_j} E_A(C) 
    &= \alpha_{A} \nabla_{\vec{v}_j} A_2(C) \\
    &= \dfrac{\alpha_{A}}{2} (A_{C} - A_d) \begin{pmatrix} v_{j+1}^{y} - v_{j-1}^{y} \\[0.5em]  v_{j-1}^{x} - v_{j+1}^{x} \end{pmatrix},
\end{align*}
where we used 
\begin{align*}
    \nabla_{\vec{v}_j} A_2(C) &= \dfrac{1}{2} (A_{C} - A_d) \begin{pmatrix} v_{j+1}^{y} - v_{j-1}^{y} \\[0.5em]  v_{j-1}^{x} - v_{j+1}^{x} \end{pmatrix},
\end{align*}
from Equation~\eqref{gradient:area}. \\
Thus, we can write down the cell wise gradient as 
\begin{align}
    \begin{split}
        &\nabla_C E_A(C) 
        =  \dfrac{\alpha_{A}}{2} (A_{C} - A_d) 
        \begin{pmatrix}   
            v_{2}^{y} - v_{N_V}^{y} \\[0.5em]  v_{N_V}^{x} - v_{2}^{x} \\ 
            v_{3}^{y} - v_{1  }^{y} \\[0.5em]  v_{1  }^{x} - v_{3}^{x} \\ 
            \vdots \\  
            v_{N_V}^{y} - v_{N_V-2}^{y} \\[0.5em]  v_{N_V-2}^{x} - v_{N_V}^{x}\\  
            v_{1}^{y} - v_{N_V-1}^{y} \\[0.5em]  v_{N_V-1}^{x} - v_{1}^{x} 
        \end{pmatrix} \\[0.5em]
        &=  \dfrac{\alpha_{A}}{2} (A_{C} - A_d) \underbrace{\begin{pmatrix} 
            0 &  0 &  0 & 1 & 0  & 0  \; \cdots \; 0 & 0 & 0 & -1 \\
            0 &  0 & -1 & 0 & 0  & 0  \; \cdots \; 0 & 0 & 1 & 0 \\
            0 & -1 &  0 & 0 & 0  & 1  \; \cdots \; 0 & 0 & 0 & 0 \\
            1 &  0 &  0 & 0 & -1 & 0  \; \cdots \; 0 & 0 & 0 & 0 \\[0.5em]
            &    &    &   &   \hspace{1cm}    \vdots     &     &   &   & \\[0.5em]
            0  &  0 &  0 & 0 & 0 & 0 \; \cdots \; 0 &  0 &  0 & 1 \\
            0  &  0 &  0 & 0 & 0 & 0  \; \cdots \; 0 &  0 & -1 & 0 \\
            0  &  1 &  0 & 0 & 0 & 0  \; \cdots \; 0 & -1 &  0 & 0 \\
            -1 &  0 &  0 & 0 & 0 & 0  \; \cdots \; 1 &  0 &  0 & 0 \\
        \end{pmatrix}}_{= M_A} \underbrace{\begin{pmatrix} v_1^x \\ v_1^y \\ v_2^x \\ v_2^y \\ \vdots \\ v_{N_V-1}^x \\ v_{N_V-1}^y \\ v_{N_V}^x \\ v_{N_V}^y\end{pmatrix}}_{= V_C}. \\
    \end{split}
\end{align}

Now, we want to consider the exckusive scaled \textbf{edge energy}, i.e.
\begin{align*}
    E_E(C) = \alpha_{E} E_2(C) = \frac{\alpha_{E}}{2} \sum\limits_{j=1}^{N_V} |E^j_{C} - E^{j}_d|^2,
\end{align*}
with actual edge length $E^j_{C} = \norm[\vec{v}_j - \vec{v}_{j+1}]$ and desired length $E^{j}_d$ at edge $j$.
We took $E_2(C)$ from Equation~\eqref{eq:edgeEnergy} with $k=2$. 
In this case we can compute the gradient as 
\begin{align*}
    \nabla_C E_E(C) 
    &=  \begin{pmatrix}  \nabla_{\vec{v}_1} \\ \vdots \\  \nabla_{\vec{v}_{N_V}} \end{pmatrix} E_E(C),
\end{align*}
with 
\begin{align*}
    \nabla_{\vec{v}_j} E_E(C) 
    &= \alpha_{E} \nabla_{\vec{v}_j} E_2(C) \\
    &= \alpha_{E} \left( \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j-1}^{x} \\[0.5em]  v_{j}^{y} - v_{j-1}^{y}  \end{pmatrix} 
    + \dfrac{E^j_{C} - E_d^{j}}{E^j_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j+1}^{x} \\[0.5em]  v_{j}^{y} - v_{j+1}^{y} \end{pmatrix} \right) ,
\end{align*}
where we used 
\begin{align*}
    \nabla_{\vec{v}_j} E_2(C) &=  \dfrac{E^{j-1}_{C}- E_d^{j-1}}{E^{j-1}_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j-1}^{x} \\[0.5em]  v_{j}^{y} - v_{j-1}^{y}  \end{pmatrix} 
    + \dfrac{E^j_{C} - E_d^{j}}{E^j_{C}}  
    \begin{pmatrix} v_{j}^{x} - v_{j+1}^{x} \\[0.5em]  v_{j}^{y} - v_{j+1}^{y} \end{pmatrix},
\end{align*}
from Equation~\eqref{gradient:edge}. \\
If we define matrices for the prefactors: $D_E, D_{E-} \in \R^{2 N_V \times 2 N_V}$ as
\begin{align*}
    D_E = \diag[\frac{E_C^{1} - E_d^{1}}{E_C^{1}}, \frac{E_C^{1} - E_d^{1}}{E_C^{1}},  \ldots, \frac{E_C^{N_V} - E_d^{N_V}}{E_C^{N_V}}, \frac{E_C^{N_V} - E_d^{N_V}}{E_C^{N_V}}],
\end{align*}
and 
\begin{align*}
    D_{E-} = \diag[\tfrac{E_C^{N_V} - E_d^{N_V}}{E_C^{N_V}}, \tfrac{E_C^{N_V} - E_d^{N_V}}{E_C^{N_V}}, \tfrac{E_C^{1} - E_d^{1}}{E_C^{1}}, \tfrac{E_C^{1} - E_d^{1}}{E_C^{1}},  \ldots, \tfrac{E_C^{N_V-1} - E_d^{N_V-1}}{E_C^{N_V-1}}].
\end{align*}
And rewrite the following parts as  
\begin{align*}
    M_E = \begin{pmatrix}
        1 & 0 & -1 & 0 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        0 & 1 & 0 & -1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        0 & 0 & 1 & 0 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        0 & 0 & 0 & 1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
          &   &   &    \vdots  &   &   & \\[0.5em]
        0 & 0 & 0 & 0 \: \cdots \: 1 & 0 & 0 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 0 & 1 &  0 & 0 \\ 
        -1 & 0 & 0 & 0 \: \cdots \: 0 & 0 &  1 & 0 \\ 
        0 & -1 & 0 & 0 \: \cdots \: 0 & 0 &  0 & 1 \\ 
    \end{pmatrix} \in \R^{2N_V \times 2 N_V},
\end{align*}
and 
\begin{align*}
    M_{E-} = \begin{pmatrix}
        1 & 0 & 0 & 0 \: \cdots \: 0 & 0 & -1 & 0 \\ 
        0 & 1 & 0 & 0 \: \cdots \: 0 & 0 &  0 & -1\\ 
        -1& 0 & 1 & 0 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        0 & -1& 0 & 1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
          &   &   &    \vdots  &   &   & \\[0.5em]
        0 & 0 & 0 & 0 \: \cdots \: 1 & 0 & 0 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 0 & 1 &  0 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: -1& 0 &  1 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 0 & -1&  0 & 1 \\ 
    \end{pmatrix} \in \R^{2N_V \times 2 N_V}.
\end{align*}
We can conclude a cell wise edge energy gradient as 
\begin{align}
    \begin{split}
        &\nabla_C E_E(C) 
        =  \alpha_{E} \left(  D_{E-} M_{E-} + D_{E} M_{E} \right) V_C.
    \end{split}
\end{align}


Next, we consider a system with pure scaled \textbf{interior angle energy}, i.e. 
\begin{align*}
    E_I(C) = \alpha_{I} I_2(C) = \frac{\alpha_{I}}{2} \sum\limits_{j=1}^{N_V} | I^j_{C} - I^{j}_d |^2
\end{align*}
where we used 
\begin{align*}
    I_2(C) = \sum\limits_{j=1}^{N_V} \frac{1}{2}| I^j_{C} - I^{j}_d |^2, 
\end{align*}
from Equation~\eqref{eq:intAngleEnergy} with $k=2$. \\
In Chapter~\ref{dynamics}, we already computed the first derivative as 
\begin{align*}
    \begin{split}
        \nabla_{\vec{v}_j} I_2(C) 
        &= (I^{j-1}_{C} - I^{j-1}_d) \left( 
                - \frac{1}{(E_C^j)^{2}} \begin{pmatrix}
                    v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
                    v_{j}^{x} - v_{j-1}^{x}
                \end{pmatrix} 
            \right) \\[0.5em] 
        &+(I^{j}_{C} - I^{j}_d) \Biggl( 
            \frac{1}{(E_C^j)^{2}} \begin{pmatrix}
            v_{j-1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j-1}^{x}
            \end{pmatrix} 
            - \frac{1}{(E_C^{j+1})^2} \begin{pmatrix}
            v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j+1}^{x}
            \end{pmatrix} 
            \Biggr) \\[0.5em] 
        &+ (I^{j+1}_{C} - I^{j+1}_d) \left( 
            \frac{1}{(E_C^{j+1})^2} \begin{pmatrix}
            v_{j+1}^{y} - v_{j}^{y} \\[0.5em]
            v_{j}^{x} - v_{j+1}^{x}
            \end{pmatrix} 
            \right), %\\[0.5em] 
    \end{split}
\end{align*}
in Equation~\eqref{gradient:angle}. \\
We define the matrices $D_I, D_{I-}, D_{I+} \in \R^{2N_V \times 2N_V}$ as 
\begin{center}
    $D_I = \diag[I^{1}_{C} - I^{1}_d, I^{1}_{C} - I^{1}_d, I^{2}_{C} - I^{2}_d, I^{2}_{C} - I^{2}_d,\ldots, I^{N_V}_{C} - I^{N_V}_d, I^{N_V}_{C} - I^{N_V}_d]$, \\[0.5em]
    $D_{I-} = \text{diag}\bigl(  $ {\footnotesize$I^{N_V}_{C} - I^{N_V}_d, I^{N_V}_{C} - I^{N_V}_d, I^{1}_{C} - I^{1}_d, I^{1}_{C} - I^{1}_d,\ldots, I^{N_V-1}_{C} - I^{N_V-1}_d, I^{N_V-1}_{C} - I^{N_V-1}_d$}$\bigr)$,\\[0.5em]
    $D_{I+} = \diag[I^{2}_{C} - I^{2}_d, I^{2}_{C} - I^{2}_d,\ldots, I^{N_V}_{C} - I^{N_V}_d, I^{N_V}_{C} - I^{N_V}_d, I^{1}_{C} - I^{1}_d, I^{1}_{C} - I^{1}_d]$. \\
\end{center}
The terms of form $\frac{1}{(E^j_C)^2}$ and  $\frac{1}{(E^{j+1}_C)^2}$ are summerised in $B_I, B_{I+} \in \R^{2N_V \times 2N_V}$ as, 
\begin{center}
    $B_I = \diag[(E^1_C)^{-2}, (E^1_C)^{-2}, \ldots, (E^{N_V}_C)^{-2}, (E^{N_V}_C)^{-2}]$, \\[0.5em]
    $B_{I+} = \diag[(E^2_C)^{-2}, (E^2_C)^{-2}, \ldots, (E^{N_V}_C)^{-2}, (E^{N_V}_C)^{-2}, (E^{1}_C)^{-2}, (E^{1}_C)^{-2}]$. \\[0.5em]
\end{center}
Finally, we put together  missing vertex terms with matrices $M_{I-}, M_{I+} \in \R^{2N_V \times 2N_V}$ as
\begin{align*}
    M_{I-} = \begin{pmatrix}
        0 & -1 & 0 & 0 \: \cdots \: 0 & 0 &  0 & 1 \\ 
        1 & 0 & 0 & 0 \: \cdots \: 0 & 0 &  -1 & 0\\ 
        0 & 1 & 0 & -1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        -1 & 0 & 1 & 0 \: \cdots \: 0 & 0 &  0 & 0 \\ 
          &   &   &    \vdots  &   &   & \\[0.5em]
        0 & 0 & 0 & 0 \: \cdots \: 0 & -1 &  0 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 1 & 0 &  0 & 0 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 0 & 1 &  0 & -1 \\ 
        0 & 0 & 0 & 0 \: \cdots \: -1 & 0 &  1 & 0 \\ 
    \end{pmatrix}, \\[0.5em]
     M_{I+} = \begin{pmatrix}
        0 & -1 & 0 & 1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        1 & 0 & -1 & 0 \: \cdots \: 0 & 0 &  0 & 0\\ 
        0 & 0 & 0 & -1 \: \cdots \: 0 & 0 &  0 & 0 \\ 
        0 & 0 & 1 & 0 \: \cdots \: 0 & 0 &  0 & 0 \\ 
          &   &   &    \vdots  &   &   & \\[0.5em]
        0 & 0 & 0 & 0 \: \cdots \: 0 & -1 &  0 & 1 \\ 
        0 & 0 & 0 & 0 \: \cdots \: 1 & 0 &  -1 & 0 \\ 
        0 & 1 & 0 & 0 \: \cdots \: 0 & 0 &  0 & -1 \\ 
        -1 & 0 & 0 & 0 \: \cdots \: 0 & 0 &  1 & 0 \\ 
    \end{pmatrix}.
\end{align*} 
We can write down the cell wise interior angle gradient as 
\begin{align}
    \begin{split}
        \nabla_C E_I(C) = \alpha_I \Bigl( & - D_{I-} B_I M_{I-}  + D_I \left(  B_I M_{I-}  - B_{I+}  M_{I+}   \right) 
                                      + D_{I+} B_{I+} M_{I+}  \Bigr) V_C.
    \end{split}
\end{align}


